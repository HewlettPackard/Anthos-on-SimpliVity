(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{394:function(e,t,i){e.exports=i.p+"assets/img/kiali-all-v1.1cb4d0a9.png"},395:function(e,t,i){e.exports=i.p+"assets/img/kiali-50-50.2f874243.png"},462:function(e,t,i){"use strict";i.r(t);var a=i(35),s=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"managing-traffic"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#managing-traffic"}},[e._v("#")]),e._v(" Managing traffic")]),e._v(" "),a("h3",{attrs:{id:"destination-rules"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#destination-rules"}},[e._v("#")]),e._v(" Destination rules")]),e._v(" "),a("p",[e._v("Before you can use Istio to control the Bookinfo version routing, you need to define the available versions, called subsets, in destination rules.")]),e._v(" "),a("p",[e._v("The service mesh playbook does not currently enable mutual TLS, so download the appropriate manifest for destination rules.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("curl https://raw.githubusercontent.com/istio/istio/release-1.6/samples/bookinfo/networking/destination-rule-all.yaml > destination-rule-all.yaml\n")])])]),a("p",[e._v("Deploy the destination rules:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl -n bookinfo apply -f destination-rule-all.yaml\n\ndestinationrule.networking.istio.io/productpage created\ndestinationrule.networking.istio.io/reviews created\ndestinationrule.networking.istio.io/ratings created\ndestinationrule.networking.istio.io/details created\n")])])]),a("h3",{attrs:{id:"route-all-traffic-to-one-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#route-all-traffic-to-one-service"}},[e._v("#")]),e._v(" Route all traffic to one service")]),e._v(" "),a("p",[e._v("Route all traffic to the "),a("code",[e._v("v1")]),e._v(" version of the services by applying the file "),a("code",[e._v("virtual-service-all-v1.yaml")]),e._v(".")]),e._v(" "),a("p",[e._v("Download the appropriate manifest:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("curl https://raw.githubusercontent.com/istio/istio/release-1.6/samples/bookinfo/networking/virtual-service-all-v1.yaml >  virtual-service-all-v1.yaml\n")])])]),a("p",[e._v("If you examine the file, you will see that all reviews are routed to "),a("code",[e._v("v1")]),e._v(" of the reviews serivce, i.e. the version that\nproduces no stars:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n")])])]),a("p",[e._v("Deploy the virtual services:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl -n bookinfo apply -f virtual-service-all-v1.yaml\n\nvirtualservice.networking.istio.io/productpage created\nvirtualservice.networking.istio.io/reviews created\nvirtualservice.networking.istio.io/ratings created\nvirtualservice.networking.istio.io/details created\n")])])]),a("p",[e._v("Now, when you refresh the product page in your browser, you will now only ever see the reviews without any\n(black or red) star ratings. In the Kiali versioned app graph, the percentage of requests for "),a("code",[e._v("v1")]),e._v(" of the reviews\nservice will grow to 100% while the percentage for the other two versions will drop to zero over time.")]),e._v(" "),a("p",[a("img",{attrs:{src:i(394),alt:' "Kiali requests percentage for v1"'}})]),e._v(" "),a("p",[a("strong",[e._v("Figure.")]),e._v(" Kiali requests percentage for "),a("code",[e._v("v1")])]),e._v(" "),a("h3",{attrs:{id:"splitting-traffic-between-versions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#splitting-traffic-between-versions"}},[e._v("#")]),e._v(" Splitting traffic between versions")]),e._v(" "),a("p",[e._v("You can split the traffic 50/50 between "),a("code",[e._v("v1")]),e._v(" and "),a("code",[e._v("v3")]),e._v(" of the reviews service by applying the file "),a("code",[e._v("virtual-service-reviews-50-v3.yaml")]),e._v(".")]),e._v(" "),a("p",[e._v("Download the appropriate manifest:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("curl https://raw.githubusercontent.com/istio/istio/release-1.6/samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml > virtual-service-reviews-50-v3.yaml\n")])])]),a("p",[e._v("In the manifest, you will see that the "),a("code",[e._v("v1")]),e._v(" and "),a("code",[e._v("v3")]),e._v(" destinations for the reviews service both have a "),a("code",[e._v("weight: 50")]),e._v("\nmeaning the traffic will be split equally between these two versions.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 50\n    - destination:\n        host: reviews\n        subset: v3\n      weight: 50\n")])])]),a("p",[e._v("Deploy the updated virtual service:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("kubectl -n bookinfo apply -f virtual-service-reviews-50-v3.yaml\n\nvirtualservice.networking.istio.io/reviews configured\n")])])]),a("p",[e._v("Wait a few seconds for the new rules to propagate. Now, refresh the homepage in your browser and you should see red\ncolored star ratings approximately 50% of the time ("),a("code",[e._v("v3")]),e._v("), with the other 50% having no stars ("),a("code",[e._v("v1")]),e._v("). In the Kiali\nversioned app graph, the percentage of request going to the "),a("code",[e._v("v1")]),e._v(" service will drop fromm 100% to 50%, while the "),a("code",[e._v("v3")]),e._v("\nservice will grow from 0% to 50%.")]),e._v(" "),a("p",[a("img",{attrs:{src:i(395),alt:'"Kiali 50-50 split"'}})]),e._v(" "),a("p",[a("strong",[e._v("Figure.")]),e._v(" Kiali 50-50 split")])])}),[],!1,null,null,null);t.default=s.exports}}]);