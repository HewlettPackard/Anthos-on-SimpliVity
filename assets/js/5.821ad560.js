(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{401:function(e,a,t){e.exports=t.p+"assets/img/bookinfo-overview.534176e8.png"},402:function(e,a,t){e.exports=t.p+"assets/img/servicemesh-productpage1.36a5a778.png"},403:function(e,a,t){e.exports=t.p+"assets/img/servicemesh-productpage-internal.43d00f72.png"},404:function(e,a,t){e.exports=t.p+"assets/img/servicemesh-productpage2.7b3a237e.png"},405:function(e,a,t){e.exports=t.p+"assets/img/servicemesh-productpage3.90cf42d2.png"},435:function(e,a,t){"use strict";t.r(a);var s=t(35),o=Object(s.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"service-mesh-sample-application-bookinfo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-mesh-sample-application-bookinfo"}},[e._v("#")]),e._v(" Service mesh sample application - Bookinfo")]),e._v(" "),s("h2",{attrs:{id:"bookinfo-application-overview"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bookinfo-application-overview"}},[e._v("#")]),e._v(" Bookinfo application overview")]),e._v(" "),s("p",[e._v("The example deploys a sample application composed of four separate microservices used to demonstrate various Istio features. The application displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a description of the book, book details (ISBN, number of pages, and so on), and a few book reviews.")]),e._v(" "),s("p",[e._v("The Bookinfo application is broken into four separate microservices:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("productpage:")]),e._v(" The productpage microservice calls the details and reviews microservices to populate the page.")]),e._v(" "),s("li",[s("strong",[e._v("details:")]),e._v(" The details microservice contains book information.")]),e._v(" "),s("li",[s("strong",[e._v("reviews:")]),e._v(" The reviews microservice contains book reviews. It also calls the ratings microservice.")]),e._v(" "),s("li",[s("strong",[e._v("ratings:")]),e._v(" The ratings microservice contains book ranking information that accompanies a book review.")])]),e._v(" "),s("p",[e._v("There are 3 versions of the reviews microservice:")]),e._v(" "),s("ul",[s("li",[e._v("Version "),s("code",[e._v("v1")]),e._v(" doesn’t call the ratings service.")]),e._v(" "),s("li",[e._v("Version "),s("code",[e._v("v2")]),e._v(" calls the ratings service, and displays each rating as 1 to 5 black stars.")]),e._v(" "),s("li",[e._v("Version "),s("code",[e._v("v3")]),e._v(" calls the ratings service, and displays each rating as 1 to 5 red stars.")])]),e._v(" "),s("p",[e._v("The end-to-end architecture of the application is shown below.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(401),alt:' "Bookinfo application"'}})]),e._v(" "),s("p",[s("strong",[e._v("Figure.")]),e._v(" Bookinfo application")]),e._v(" "),s("h2",{attrs:{id:"deploy-the-bookinfo-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-the-bookinfo-application"}},[e._v("#")]),e._v(" Deploy the Bookinfo application")]),e._v(" "),s("h3",{attrs:{id:"connect-to-your-admin-workstation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#connect-to-your-admin-workstation"}},[e._v("#")]),e._v(" Connect to your admin workstation")]),e._v(" "),s("p",[e._v("Connect to your admin workstation, using the appropriate IP address:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("ssh -i /root/anthos_secrets/vsphere_workstation ubuntu@10.15.155.200\n")])])]),s("h3",{attrs:{id:"configure-kubeconfig"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-kubeconfig"}},[e._v("#")]),e._v(" Configure KUBECONFIG")]),e._v(" "),s("p",[e._v("Configure KUBECONFIG, using the appropriate  cluster name:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("export KUBECONFIG=~/kubeconfigs/gmcg-gke-usercluster-1-kubeconfig\n")])])]),s("h3",{attrs:{id:"create-namespace"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-namespace"}},[e._v("#")]),e._v(" Create namespace")]),e._v(" "),s("p",[e._v("Create a namespace for the application:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl create namespace bookinfo\n\nnamespace/bookinfo created\n")])])]),s("h3",{attrs:{id:"enable-istio-injection-for-namespace"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#enable-istio-injection-for-namespace"}},[e._v("#")]),e._v(" Enable Istio injection for namespace")]),e._v(" "),s("p",[e._v("If you have already deployed Service Mesh to the user cluster,"),s("br"),e._v("\nyou can simply use "),s("code",[e._v("kubectl")]),e._v(" to enable Istio injection for the namespace:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl label namespace bookinfo istio-injection=enabled\n")])])]),s("p",[e._v("Otherwise, you need to "),s("a",{attrs:{href:"../core-config/service-mesh-config"}},[e._v("configure")]),e._v(" and "),s("a",{attrs:{href:"../playbooks/playbook-service-mesh"}},[e._v("run")]),e._v(" the Service Mesh playbook.  To summarize, you need to set "),s("code",[e._v("anthos_service_mesh_enable: true")]),e._v(" and add the "),s("code",[e._v("'bookinfo'")]),e._v(" namespace to the list of enabled namespaces in the "),s("code",[e._v("all.yml")]),e._v(" configuration file:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("gke_cluster_config:\n    - name: 'user-cluster-1'\n      type: 'user'\n      ...\n      anthos_service_mesh_enable: true\n      anthos_service_mesh_externalIP: '10.15.158.55'\n      anthos_service_mesh_sidecar_enable: ['bookinfo']\n")])])]),s("p",[e._v("Run the "),s("code",[e._v("service_mesh.yml")]),e._v(" playbook:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("ansible-playbook playbooks/service_mesh.yml  \n")])])]),s("h3",{attrs:{id:"check-that-istio-injection-has-been-enabled"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#check-that-istio-injection-has-been-enabled"}},[e._v("#")]),e._v(" Check that Istio injection has been enabled")]),e._v(" "),s("p",[e._v("Check that the namespace has been annotated correctly with "),s("code",[e._v("istio-injection: enabled")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('kubectl get namespace bookinfo -o yaml\n\napiVersion: v1\nkind: Namespace\nmetadata:\n  creationTimestamp: "2020-06-17T15:53:30Z"\n  labels:\n    istio-injection: enabled\n  name: bookinfo\n  resourceVersion: "661536"\n  selfLink: /api/v1/namespaces/bookinfo\n  uid: 403dadce-c754-410f-a2ee-39374bedcfe8\nspec:\n  finalizers:\n  - kubernetes\nstatus:\n  phase: Active\n')])])]),s("h3",{attrs:{id:"deploying-the-bookinfo-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploying-the-bookinfo-application"}},[e._v("#")]),e._v(" Deploying the Bookinfo application")]),e._v(" "),s("p",[e._v("Download the manifest for deploying the application:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("curl https://raw.githubusercontent.com/istio/istio/release-1.6/samples/bookinfo/platform/kube/bookinfo.yaml > bookinfo.yaml\n")])])]),s("p",[e._v("Deploy the application in the namepsace:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl -n bookinfo apply -f bookinfo.yaml\n\nservice/details created\nserviceaccount/bookinfo-details created\ndeployment.apps/details-v1 created\nservice/ratings created\nserviceaccount/bookinfo-ratings created\ndeployment.apps/ratings-v1 created\nservice/reviews created\nserviceaccount/bookinfo-reviews created\ndeployment.apps/reviews-v1 created\ndeployment.apps/reviews-v2 created\ndeployment.apps/reviews-v3 created\nservice/productpage created\nserviceaccount/bookinfo-productpage created\ndeployment.apps/productpage-v1 created\n")])])]),s("p",[e._v("View the resources deployed:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl -n bookinfo get deployment\n\nNAME             READY   UP-TO-DATE   AVAILABLE   AGE\ndetails-v1       1/1     1            1           5m58s\nproductpage-v1   1/1     1            1           5m58s\nratings-v1       1/1     1            1           5m58s\nreviews-v1       1/1     1            1           5m58s\nreviews-v2       1/1     1            1           5m58s\nreviews-v3       1/1     1            1           5m58s\n\n\nkubectl -n bookinfo get pods\n\nNAME                              READY   STATUS    RESTARTS   AGE\ndetails-v1-7f6df6f54-cxkdx        2/2     Running   0          6m29s\nproductpage-v1-69886c8bcb-4g5q9   2/2     Running   0          6m29s\nratings-v1-6665bbd4db-srbmt       2/2     Running   0          6m29s\nreviews-v1-7fd87d96bd-74z49       2/2     Running   0          6m29s\nreviews-v2-55d9bfb6d8-2gmj5       2/2     Running   0          6m29s\nreviews-v3-5776c54c64-rn86f       2/2     Running   0          6m29s\n\n\nkubectl -n bookinfo get svc\n\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.104.35.78     <none>        9080/TCP   6m54s\nproductpage   ClusterIP   10.96.108.148    <none>        9080/TCP   6m54s\nratings       ClusterIP   10.103.184.167   <none>        9080/TCP   6m54s\nreviews       ClusterIP   10.96.117.99     <none>        9080/TCP   6m54s\n\n")])])]),s("p",[e._v("Notice that there is a "),s("strong",[e._v("sidecar")]),e._v(" container "),s("code",[e._v("istio-proxy")]),e._v(" in each pod:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('kubectl -n bookinfo describe pod productpage\n\nName:           productpage-v1-69886c8bcb-4g5q9\nNamespace:      bookinfo\nPriority:       0\nNode:           gmcg-gke-user1-node2/10.15.155.122\nStart Time:     Wed, 17 Jun 2020 16:00:36 +0000\nLabels:         app=productpage\n                pod-template-hash=69886c8bcb\n                security.istio.io/tlsMode=istio\n                version=v1\nAnnotations:    cni.projectcalico.org/podIP: 192.168.0.23/32\n                sidecar.istio.io/status:\n                  {"version":"06276c8f39527e9d938cdb12b45ed9dda7fc3bedca74d940552168bfc3d957cc","initContainers":["istio-init"],"containers":["istio-proxy"]...\n...\nContainers:\n  productpage:\n    Container ID:   docker://927727491ccd40378e22e5a27f2388e3890689f6f88b997b4092d9d613e4c45c\n    Image:          docker.io/istio/examples-bookinfo-productpage-v1:1.15.1\n    Image ID:       docker-pullable://istio/examples-bookinfo-productpage-v1@sha256:d54717a1bd3c8e4a12fa887aadbb764e594099a255b3b892da1483a528b6856c\n    Port:           9080/TCP\n    ...\n  istio-proxy:\n    Container ID:  docker://f6d2863e728d3919171d80975af5255167a8a33377645588a1b7647578e69ca8\n    Image:         gcr.io/gke-release/asm/proxyv2:1.4.9-asm.1\n    Image ID:      docker-pullable://gcr.io/gke-release/asm/proxyv2@sha256:4661ed09fb7f0450aecd2c7cb6aa42ea697955f88b32920437796d6de5b9669e\n    Port:          15090/TCP\n')])])]),s("h3",{attrs:{id:"test-the-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#test-the-application"}},[e._v("#")]),e._v(" Test the application")]),e._v(" "),s("p",[e._v("Use "),s("code",[e._v("curl")]),e._v(" to ensure that the application is running.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('kubectl -n bookinfo exec -it "$(kubectl -n bookinfo get pod -l app=ratings -o jsonpath=\'{.items[0].metadata.name}\')" -c ratings -- curl productpage:9080/productpage | grep -o "<title>.*</title>"\n')])])]),s("p",[e._v("The application title should be returned.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("<title>Simple Bookstore App</title>\n")])])]),s("h3",{attrs:{id:"deploy-the-gateway"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-the-gateway"}},[e._v("#")]),e._v(" Deploy the gateway")]),e._v(" "),s("p",[e._v("Download the appropriate manifest file:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("curl https://raw.githubusercontent.com/istio/istio/release-1.6/samples/bookinfo/networking/bookinfo-gateway.yaml > bookinfo-gateway.yaml\n")])])]),s("p",[e._v("Deploy the gateway in the namespace:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl -n bookinfo apply -f bookinfo-gateway.yaml\n\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n")])])]),s("p",[e._v("Determine the ingress IP:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl get svc istio-ingressgateway -n istio-system\n\nNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                                                                                                      AGE\nistio-ingressgateway   LoadBalancer   10.110.50.233   10.15.158.55   15020:30970/TCP,80:32417/TCP,443:30921/TCP,15029:32551/TCP,15030:30335/TCP,15031:30934/TCP,15032:31978/TCP,15443:31414/TCP   4h57m\n")])])]),s("p",[s("strong",[e._v("Note:")]),e._v(" The ingress IP will match the value in the variable "),s("code",[e._v("gke_cluster_config.anthos_service_mesh_externalIP")]),e._v(" in the "),s("code",[e._v("all.yml")]),e._v("\nconfiguration file.")]),e._v(" "),s("h3",{attrs:{id:"confirm-the-application-is-accessible-from-outside-the-cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#confirm-the-application-is-accessible-from-outside-the-cluster"}},[e._v("#")]),e._v(" Confirm the application is accessible from outside the cluster")]),e._v(" "),s("p",[e._v("Using the ingress IP, you can use "),s("code",[e._v("curl")]),e._v(" to access the application homepage, for example:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v(' curl -s "http://10.15.158.55/productpage" | grep -o "<title>.*</title>"\n')])])]),s("p",[e._v("The application title should be returned.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("<title>Simple Bookstore App</title>\n")])])]),s("p",[e._v("Alternatively, browse to the URL, for example, "),s("code",[e._v("http://10.15.158.55/productpage")]),e._v(":")]),e._v(" "),s("p",[s("img",{attrs:{src:t(402),alt:' "Bookinfo homepage"'}})]),e._v(" "),s("p",[s("strong",[e._v("Figure.")]),e._v(" Bookinfo homepage")]),e._v(" "),s("h3",{attrs:{id:"access-the-application-using-an-interal-address"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#access-the-application-using-an-interal-address"}},[e._v("#")]),e._v(" Access the application using an interal address")]),e._v(" "),s("p",[e._v("In the output for the service "),s("code",[e._v("istio-ingressgateway")]),e._v(" above, notice that port "),s("code",[e._v("80")]),e._v(" is mapped to port "),s("code",[e._v("32417")]),e._v(".\nThis means that you can access the application using the internal IP address for any node in your user cluster, along with port "),s("code",[e._v("32417")]),e._v(".")]),e._v(" "),s("p",[e._v("You can easily discover\nthe IP addresses of your nodes using the "),s("code",[e._v("-o wide")]),e._v(" flag on the "),s("code",[e._v("kubectl get nodes")]),e._v(" command. In the sample user cluster, the four IP addresses are statically configured as "),s("code",[e._v("10.15.155.121-124")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl get nodes -o wide\n\nNAME                   STATUS   ROLES    AGE    VERSION          INTERNAL-IP     EXTERNAL-IP     OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\ngmcg-gke-user1-node1   Ready    <none>   2d2h   v1.16.8-gke.6   10.15.155.121   10.15.155.121   Ubuntu 18.04.4 LTS   5.3.0-53-generic   docker://19.3.2\ngmcg-gke-user1-node2   Ready    <none>   2d2h   v1.16.8-gke.6   10.15.155.122   10.15.155.122   Ubuntu 18.04.4 LTS   5.3.0-53-generic   docker://19.3.2\ngmcg-gke-user1-node3   Ready    <none>   2d2h   v1.16.8-gke.6   10.15.155.123   10.15.155.123   Ubuntu 18.04.4 LTS   5.3.0-53-generic   docker://19.3.2\ngmcg-gke-user1-node4   Ready    <none>   2d2h   v1.16.8-gke.6   10.15.155.124   10.15.155.124   Ubuntu 18.04.4 LTS   5.3.0-53-generic   docker://19.3.2\n")])])]),s("p",[e._v("Using the IP address of one of the nodes, together with port (in this instance "),s("code",[e._v("32417")]),e._v("), you can use "),s("code",[e._v("curl")]),e._v(" or the browser to access the application homepage:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("curl http://10.15.155.124:32417/productpage\n")])])]),s("p",[s("img",{attrs:{src:t(403),alt:' "Bookinfo homepage using internal address"'}})]),e._v(" "),s("p",[s("strong",[e._v("Figure.")]),e._v(" Bookinfo homepage using internal address")]),e._v(" "),s("h3",{attrs:{id:"multiple-version-of-the-reviews-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#multiple-version-of-the-reviews-service"}},[e._v("#")]),e._v(" Multiple version of the reviews service")]),e._v(" "),s("p",[e._v("All 3 versions of the reviews service, "),s("code",[e._v("v1")]),e._v(", "),s("code",[e._v("v2")]),e._v(", and "),s("code",[e._v("v3")]),e._v(", are deployed at the same time.\nAs a result, when  you refresh the homepage, you should see different ratings output\n(black stars, red stars or no stars).")]),e._v(" "),s("p",[s("img",{attrs:{src:t(404),alt:' "Bookinfo homepage - black stars"'}})]),e._v(" "),s("p",[s("strong",[e._v("Figure.")]),e._v(" Bookinfo homepage - black stars")]),e._v(" "),s("p",[s("img",{attrs:{src:t(405),alt:' "Bookinfo homepage - red stars"'}})]),e._v(" "),s("p",[s("strong",[e._v("Figure.")]),e._v(" Bookinfo homepage - red stars")]),e._v(" "),s("p",[e._v("In a realistic deployment, new versions of a microservice are deployed over time instead of deploying all versions simultaneously.")])])}),[],!1,null,null,null);a.default=o.exports}}]);